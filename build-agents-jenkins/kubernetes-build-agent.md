### Notes to use Kubernetes cluster as build agent For Jenkins

#### Setting up Jenkins

1. Open `Manage Jenkins` -> `Manage Plugins` -> `Available` -> `Search for Kubernetes` -> `Install`
2. Do a safe restart of Jenkins

#### Setting up docker network connects for/to minikube and Jenkins

1. Open a terminal
2. Run the command `docker network connect bridge jenkins`
3. Run the command `docker network connect bridge minikube`

#### Setting up Kubernetes Plugin for local minikube cluster

1. Open `Manage Jenkins` -> `Configure System` -> `Add a new cloud` -> `Kubernetes`
2. Enter the Kubernetes URL as `https://<minikube-ip>:8443` and Kubernetes server certificate key as `~/.minikube/ca.crt`
3. Enter the Kubernetes Namespace as `default`
4. Create credentials for Kubernetes by selecting the `Certificate` kind from the drop-down menu. Under `Certificate`, choose `Upload PKCS#12 certificate` and upload your cert.pfx file generated by the command in `~/.minikube/profiles/minikube` directory

```sh
openssl pkcs12 -export -out cert.pfx -inkey client.key -in client.crt -certfile ../../ca.crt
```

5. Add the credentials in the kubernetes plugin configuration and click on `Test Connection` to verify the connection
6. Jenkins URL: `http://<jenkins-ip>:8080`
7. Click on `Save`

### Setting up Pod Template for Kubernetes

1. Open `Manage Jenkins` -> `Configure System` -> `Add a new Pod Template`
2. Enter the name as `kubernetes-build-agent` and select `Kubernetes Pod Template`
3. Enter the namespace as `default` and label as `kubernetes-build-agent`
4. Add the container template with the name as `jnlp` and Docker image as `jenkins/jnlp-slave`
5. Add the container template with the name as `maven` and Docker image as `maven:3.6.3-jdk-8`
6. Add the container template with the name as `golang` and Docker image as `golang:1.21.1`
7. Click on `Save`

### Setting up a new Jenkins Job

1. Open Jenkins Dashboard
2. Click on `New Item`
3. Enter the item name as `kubernetes-build-agent` and select `Pipeline`
4. Click on `OK`
5. In the Pipeline section, paste the pipeline script for testing the Kubernetes cluster as build agent

```groovy
pipeline {
  agent {
    kubernetes {
      cloud 'kubernetes'
      label 'kubernetes-build-agent'
      defaultContainer 'jnlp'
      yaml """
      apiVersion: v1
      kind: Pod
      metadata:
        labels:
          some-label: some-label-value
      spec:
        containers:
        - name: golang
          image: golang:1.21.1
          command:
          - cat
          tty: true
        - name: maven
          image: maven:3.6.3-jdk-8
          command:
          - cat
          tty: true
      """
    }
  }
  stages {
    stage('Build') {
      steps {
        container('golang') {
          sh 'go version'
        }
        container('maven') {
          sh 'mvn --version'
        }
      }
    }
  }
}
```

6. Click on `Save`

### Running the Jenkins Job

1. Click on `Build Now` to run the pipeline
2. Click on the build number to view the pipeline execution
3. Verify the build logs for the successful execution of the pipeline
